@startuml
title US-14: As a Physician, I want to record appointment details after a consultation

autonumber
autoactivate on

actor "Physician" as Physician
participant "AppointmentRecordController (Appointment Records Service)" as Controller
participant "JWTValidator" as JWT
participant "AppointmentRecordService" as RecordService
participant "AppointmentRecordRepository" as RecordRepository
database "Appointment Records DB" as RecordDB
participant "AppointmentClient (Appointments Service)" as AppointmentClient
participant "AppointmentController (Appointments Service)" as AppointmentController
participant "AppointmentService" as AppointmentService
participant "AppointmentRepository" as AppointmentRepository
database "Appointments DB" as AppointmentDB
participant "Mapper: AppointmentRecordMapper" as Mapper
participant "ViewMapper: AppointmentRecordViewMapper" as ViewMapper

Physician -> Controller : POST /appointments/{id}/record\nAuthorization: Bearer <JWT>\nBody: AppointmentRecordDTO
activate Controller

Controller -> JWT : validateToken(JWT)
activate JWT
JWT --> Controller : 200 OK (role=PHYSICIAN, physicianId)
deactivate JWT

Controller -> RecordService : recordAppointmentDetails(appointmentId, dto, physicianId)
activate RecordService

RecordService -> AppointmentClient : GET /appointments/{id}
activate AppointmentClient

AppointmentClient -> AppointmentController : GET /appointments/{id}
activate AppointmentController
AppointmentController -> AppointmentService : getAppointmentById(id)
activate AppointmentService
AppointmentService -> AppointmentRepository : findById(id)
activate AppointmentRepository
AppointmentRepository -> AppointmentDB : SELECT * FROM appointments WHERE id = ?
AppointmentDB --> AppointmentRepository : Appointment
deactivate AppointmentRepository

AppointmentRepository --> AppointmentService : Appointment
AppointmentService --> AppointmentController : AppointmentDTO
deactivate AppointmentService

AppointmentController --> AppointmentClient : 200 OK + AppointmentDTO
deactivate AppointmentController

AppointmentClient --> RecordService : AppointmentDTO
deactivate AppointmentClient

RecordService -> RecordService : validatePhysicianOwnership(AppointmentDTO, physicianId)

RecordService -> Mapper : toEntity(dto)
Mapper --> RecordService : AppointmentRecord entity

RecordService -> RecordRepository : save(record)
activate RecordRepository
RecordRepository -> RecordDB : INSERT INTO appointment_records (...)
RecordDB --> RecordRepository : savedRecord
deactivate RecordRepository

RecordRepository --> RecordService : savedRecord

RecordService -> ViewMapper : toDTO(savedRecord)
ViewMapper --> RecordService : AppointmentRecordViewDTO

RecordService --> Controller : AppointmentRecordViewDTO
deactivate RecordService

Controller --> Physician : HTTP 201 Created\nBody: AppointmentRecordViewDTO
deactivate Controller

@enduml