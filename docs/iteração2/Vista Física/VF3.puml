@startuml C4 Deployment Diagram - With API Gateway, Auth Service and RabbitMQ

!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Deployment.puml

title VF4 — API Gateway → Auth Service → Serviços + RabbitMQ


Deployment_Node(APIGatewayNode, "API Gateway", "Spring Cloud Gateway / Nginx", "Ponto de entrada para roteamento interno e externo.") {
    Container(APIGateway, "API Gateway", "Router/Proxy", "Roteia chamadas para o Auth Service e depois para os outros serviços.")
}


Deployment_Node(AuthServiceNode, "Auth Service", "Spring Boot", "Serviço de autenticação e autorização.") {
    Container(AuthController, "Auth Controller", "REST API", "Valida tokens e autentica pedidos antes de encaminhar para os serviços.")
    ContainerDb(AuthDB, "Auth Database", "H2 / Postgres", "Armazena credenciais, permissões e tokens revogados.")
}


Deployment_Node(AppointmentServiceNodeA, "Appointment Service A", "Spring Boot", "Réplica A do serviço de consultas.") {
    Container(AppointmentControllerA, "Appointment Controller A", "REST API", "Expõe /api/appointments.")
    ContainerDb(AppointmentDBA, "Appointment Database A", "H2 database", "Armazena dados das consultas.")
}


Deployment_Node(AppointmentServiceNodeB, "Appointment Service B", "Spring Boot", "Réplica B do serviço de consultas.") {
    Container(AppointmentControllerB, "Appointment Controller B", "REST API", "Expõe /api/appointments.")
    ContainerDb(AppointmentDBB, "Appointment Database B", "H2 database", "Armazena dados das consultas.")
}


Deployment_Node(PatientServiceNodeA, "Patient Service A", "Spring Boot", "Réplica A do serviço de pacientes.") {
    Container(PatientControllerA, "Patient Controller A", "REST API", "Expõe /api/patients.")
    ContainerDb(PatientDBA, "Patient Database A", "H2 database", "Armazena dados de pacientes.")
}


Deployment_Node(PatientServiceNodeB, "Patient Service B", "Spring Boot", "Réplica B do serviço de pacientes.") {
    Container(PatientControllerB, "Patient Controller B", "REST API", "Expõe /api/patients.")
    ContainerDb(PatientDBB, "Patient Database B", "H2 database", "Armazena dados de pacientes.")
}


Deployment_Node(PhysicianServiceNodeA, "Physician Service A", "Spring Boot", "Réplica A do serviço de médicos.") {
    Container(PhysicianControllerA, "Physician Controller A", "REST API", "Expõe /api/physicians.")
    ContainerDb(PhysicianDBA, "Physician Database A", "H2 database", "Armazena dados de médicos.")
}


Deployment_Node(PhysicianServiceNodeB, "Physician Service B", "Spring Boot", "Réplica B do serviço de médicos.") {
    Container(PhysicianControllerB, "Physician Controller B", "REST API", "Expõe /api/physicians.")
    ContainerDb(PhysicianDBB, "Physician Database B", "H2 database", "Armazena dados de médicos.")
}


Deployment_Node(RabbitMQNode, "RabbitMQ Broker", "RabbitMQ", "Broker de mensagens para comunicação assíncrona entre réplicas.") {
    Container(RabbitMQBroker, "RabbitMQ", "Message Broker (AMQP)", "Distribui eventos CREATE/UPDATE/DELETE entre réplicas e serviços.")
}


Rel(AuthController, AuthDB, "Lê e Escreve", "JDBC")
Rel(PatientControllerA, PatientDBA, "Lê/Escreve", "JDBC")
Rel(PatientControllerB, PatientDBB, "Lê/Escreve", "JDBC")
Rel(PhysicianControllerA, PhysicianDBA, "Lê/Escreve", "JDBC")
Rel(PhysicianControllerB, PhysicianDBB, "Lê/Escreve", "JDBC")
Rel_Down(AppointmentControllerA, AppointmentDBA, "Lê/Escreve", "JDBC")
Rel_Down(AppointmentControllerB, AppointmentDBB, "Lê/Escreve", "JDBC")


Rel(APIGatewayNode, AuthServiceNode, "Validação de credenciais", "HTTP/REST")
Rel(AuthServiceNode, AppointmentServiceNodeA, "Encaminha pedidos validados", "HTTP/REST")
Rel(AuthServiceNode, AppointmentServiceNodeB, "Encaminha pedidos validados", "HTTP/REST")

Rel(AuthServiceNode, PatientServiceNodeA, "Encaminha pedidos validados", "HTTP/REST")
Rel(AuthServiceNode, PatientServiceNodeB, "Encaminha pedidos validados", "HTTP/REST")

Rel(AuthServiceNode, PhysicianServiceNodeA, "Encaminha pedidos validados", "HTTP/REST")
Rel(AuthServiceNode, PhysicianServiceNodeB, "Encaminha pedidos validados", "HTTP/REST")


Rel(AppointmentServiceNodeA, RabbitMQNode, "Publica/Consome eventos", "AMQP")
Rel(AppointmentServiceNodeB, RabbitMQNode, "Publica/Consome eventos", "AMQP")

Rel(PatientServiceNodeA, RabbitMQNode, "Publica/Consome eventos", "AMQP")
Rel(PatientServiceNodeB, RabbitMQNode, "Publica/Consome eventos", "AMQP")

Rel(PhysicianServiceNodeA, RabbitMQNode, "Publica/Consome eventos", "AMQP")
Rel(PhysicianServiceNodeB, RabbitMQNode, "Publica/Consome eventos", "AMQP")

Rel(AuthServiceNode, RabbitMQNode, "Publica auditoria / Consome eventos", "AMQP")

@enduml