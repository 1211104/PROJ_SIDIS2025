@startuml C4 Deployment Diagram - VF3 Replication and Sync

!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Deployment.puml

title VF3 — Deployment View (Réplicas, Load Balancing e Sincronização Bidirecional)

' --- ENTRADA ---
Deployment_Node(NginxNode, "Load Balancer Externo", "Nginx", "Port 80") {
    Container(NginxService, "Nginx", "Reverse Proxy", "Encaminha para o Gateway")
}

Deployment_Node(APIGatewayNode, "API Gateway Cluster", "Spring Cloud Gateway", "Port 8089/8090") {
    Container(APIGateway, "API Gateway", "Router/Proxy", "Load Balancing & JWT Validation")
}

' --- SEGURANÇA (ISOLADA) ---
Deployment_Node(AuthServiceNode, "Auth Service Cluster", "Spring Boot", "Scalable") {
    Container(AuthController, "Auth Controller", "REST API", "Login & Register")
    ContainerDb(AuthDB, "Auth Database", "PostgreSQL", "Shared DB")
}

' --- BARRAMENTO DE MENSAGENS ---
Deployment_Node(RabbitMQNode, "Infraestrutura de Eventos", "RabbitMQ", "Port 5672") {
    Container(RabbitMQBroker, "RabbitMQ Broker", "AMQP", "Broker de Eventos")
}

' --- SERVIÇOS DE NEGÓCIO (RÉPLICAS) ---

Deployment_Node(AppNode, "Appointment Services", "Cluster") {
    Deployment_Node(AppointmentServiceNodeA, "Replica A", "Spring Boot") {
        Container(AppointmentControllerA, "Appointment SVC A", "REST API", "Port available")
        ContainerDb(AppointmentDBA, "DB A", "H2 File", "Local DB")
    }
    Deployment_Node(AppointmentServiceNodeB, "Replica B", "Spring Boot") {
        Container(AppointmentControllerB, "Appointment SVC B", "REST API", "Port available")
        ContainerDb(AppointmentDBB, "DB B", "H2 File", "Local DB")
    }
}

Deployment_Node(PhysNode, "Physician Services", "Cluster") {
    Deployment_Node(PhysicianServiceNodeA, "Replica A", "Spring Boot") {
        Container(PhysicianControllerA, "Physician SVC A", "REST API", "Port available")
        ContainerDb(PhysicianDBA, "DB A", "H2 File", "Local DB")
    }
    Deployment_Node(PhysicianServiceNodeB, "Replica B", "Spring Boot") {
        Container(PhysicianControllerB, "Physician SVC B", "REST API", "Port available")
        ContainerDb(PhysicianDBB, "DB B", "H2 File", "Local DB")
    }
}

Deployment_Node(PatNode, "Patient Services", "Cluster") {
    Deployment_Node(PatientServiceNodeA, "Replica A", "Spring Boot") {
        Container(PatientControllerA, "Patient SVC A", "REST API", "Port available")
        ContainerDb(PatientDBA, "DB A", "H2 File", "Local DB")
    }
    Deployment_Node(PatientServiceNodeB, "Replica B", "Spring Boot") {
        Container(PatientControllerB, "Patient SVC B", "REST API", "Port available")
        ContainerDb(PatientDBB, "DB B", "H2 File", "Local DB")
    }
}

' --- RELAÇÕES DE REDE (HTTP) ---
Rel_D(NginxService, APIGateway, "Forward", "HTTP")

' Load Balancing do Gateway para as Réplicas
Rel_D(APIGateway, AppointmentControllerA, "LB", "HTTP")
Rel_D(APIGateway, AppointmentControllerB, "LB", "HTTP")
Rel_D(APIGateway, PhysicianControllerA, "LB", "HTTP")
Rel_D(APIGateway, PhysicianControllerB, "LB", "HTTP")
Rel_D(APIGateway, PatientControllerA, "LB", "HTTP")
Rel_D(APIGateway, PatientControllerB, "LB", "HTTP")
Rel_L(APIGateway, AuthController, "Rota /auth", "HTTP")

' --- RELAÇÕES DE DADOS (JPA) ---
Rel(AuthController, AuthDB, "Lê/Escreve", "JDBC")
Rel(AppointmentControllerA, AppointmentDBA, "Lê/Escreve", "JDBC")
Rel(AppointmentControllerB, AppointmentDBB, "Lê/Escreve", "JDBC")
Rel(PhysicianControllerA, PhysicianDBA, "Lê/Escreve", "JDBC")
Rel(PhysicianControllerB, PhysicianDBB, "Lê/Escreve", "JDBC")
Rel(PatientControllerA, PatientDBA, "Lê/Escreve", "JDBC")
Rel(PatientControllerB, PatientDBB, "Lê/Escreve", "JDBC")

' --- RELAÇÕES ASSÍNCRONAS (SYNC COMPLETO) ---

' Appointment (Consome CQRS e Sincroniza entre si)
Rel(RabbitMQBroker, AppointmentControllerA, "Sync (Consome)", "AMQP")
Rel(AppointmentControllerA, RabbitMQBroker, "Pub Event", "AMQP")

Rel(RabbitMQBroker, AppointmentControllerB, "Sync (Consome)", "AMQP")
Rel(AppointmentControllerB, RabbitMQBroker, "Pub Event", "AMQP")

' Physician (Consome para replicar e Publica)
Rel(RabbitMQBroker, PhysicianControllerA, "Sync (Consome)", "AMQP")
Rel(PhysicianControllerA, RabbitMQBroker, "Pub Event", "AMQP")

Rel(RabbitMQBroker, PhysicianControllerB, "Sync (Consome)", "AMQP")
Rel(PhysicianControllerB, RabbitMQBroker, "Pub Event", "AMQP")

' Patient (Consome para replicar e Publica)
Rel(RabbitMQBroker, PatientControllerA, "Sync (Consome)", "AMQP")
Rel(PatientControllerA, RabbitMQBroker, "Pub Event", "AMQP")

Rel(RabbitMQBroker, PatientControllerB, "Sync (Consome)", "AMQP")
Rel(PatientControllerB, RabbitMQBroker, "Pub Event", "AMQP")

@enduml