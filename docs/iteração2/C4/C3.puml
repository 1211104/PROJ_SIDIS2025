@startuml
title C3 — Appointment Service — Component Diagram

' --- ESTILOS VISUAIS (CLEAN) ---
skinparam shadowing false
skinparam componentStyle rectangle
skinparam linetype ortho ' Linhas retas (menos confusão visual)

skinparam package {
    BackgroundColor #F9F9F9
    BorderColor #999999
    FontColor #666666
}

skinparam component {
    BackgroundColor #E6F2FF
    BorderColor #08427B
    FontColor #000000
    FontSize 13
}

skinparam database {
    BackgroundColor #61B329
    BorderColor #000000
    FontColor #FFFFFF
}

' --- SISTEMAS EXTERNOS ---
component "API Gateway" as gateway #DDDDDD
component "RabbitMQ Broker" as rabbitmq #FFD699

package "Appointment Service Container" {

    ' 1. CAMADA DE ENTRADA (CONTROLLER)
    package "Web Layer" {
        component "AppointmentController" as controller
        component "SecurityConfig" as security
    }

    ' 2. CAMADA DE NEGÓCIO (CORE)
    package "Business Layer" {
        component "AppointmentService" as service
    }

    ' 3. CAMADA DE MENSAGENS (EVENTOS)
    package "Messaging Layer" {
        component "AppointmentProducer\n(Envia Eventos)" as producer
        component "DataSyncConsumer\n(Recebe Dados)" as consumer
    }

    ' 4. CAMADA DE DADOS (REPOSITÓRIOS)
    package "Data Access Layer (CQRS)" {
        component "AppointmentRepository" as app_repo
        component "ExtPhysicianRepository" as phys_repo
        component "ExtPatientRepository" as pat_repo
    }

    database "H2 Database" as db
}

' --- FLUXO PRINCIPAL (SÍNCRONO) ---
gateway .down.> security : HTTP
security -right-> controller : Secures
controller -down-> service : Calls Logic

' --- LÓGICA DE NEGÓCIO ---
service -down-> app_repo : Persist App
service -down-> phys_repo : Validate Physician
service -down-> pat_repo : Validate Patient
service -right-> producer : Trigger Event

' --- FLUXO ASSÍNCRONO (MENSAGENS) ---
producer .right.> rabbitmq : Publish
rabbitmq .left.> consumer : Consume

' --- SINCRONIZAÇÃO DE DADOS (SYNC) ---
consumer -down-> phys_repo : Save Replica
consumer -down-> pat_repo : Save Replica

' --- LIGAÇÃO À BD ---
app_repo -down-> db : SQL
phys_repo -down-> db
pat_repo -down-> db

@enduml