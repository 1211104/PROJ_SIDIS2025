@startuml
title US-13: Update or Cancel Appointment (with Patient/Physician Event Sync)

actor User
participant "AppointmentController" as Controller
participant "JWTValidator" as JWT
participant "AppointmentService" as Service
participant "AppointmentRepository" as Repository
participant "AppointmentMapper" as Mapper
database "Appointments DB" as AppointmentsDB

participant "DataSyncConsumer" as Consumer
participant "PhysicianEvent" as PhysicianEvent
participant "PatientEvent" as PatientEvent

User -> Controller : PUT/DELETE /appointments/{id} + JWT
activate Controller

Controller -> JWT : validateToken(JWT)
JWT --> Controller : 200 OK (ADMIN or PATIENT)

alt Update Appointment
    Controller -> Service : updateAppointment(id, updateDTO)
else Cancel Appointment
    Controller -> Service : cancelAppointment(id)
end
activate Service

Service -> Repository : findById(id)
Repository -> AppointmentsDB : SELECT * WHERE id = ?
AppointmentsDB --> Repository : Appointment
Repository --> Service : Appointment

alt Update Date/Time
    Service -> Service : appointment.setDateTime(...)
else Cancel
    Service -> Service : appointment.setStatus("CANCELLED")
end

Service -> Repository : save(appointment)
Repository -> AppointmentsDB : UPDATE appointment...
AppointmentsDB --> Repository : Appointment
Repository --> Service : Appointment
Service --> Controller : Appointment

Controller -> Mapper : toAppointmentView
Mapper --> Controller : AppointmentView
Controller --> User : 200 OK + AppointmentView
deactivate Controller


PhysicianEvent -> Consumer : handlePhysicianEvent(event)
activate Consumer

alt EVENT_TYPE = DELETED
    Consumer -> Repository : physicianRepo.deleteById(event.physicianNumber)
else CREATED or UPDATED
    Consumer -> Repository : physicianRepo.save(ExternalPhysician)
end

deactivate Consumer

PatientEvent -> Consumer : handlePatientEvent(event)
activate Consumer

alt EVENT_TYPE = DELETED
    Consumer -> Repository : patientRepo.deleteById(event.patientNumber)
else CREATED or UPDATED
    Consumer -> Repository : patientRepo.save(ExternalPatient)
end

deactivate Consumer

@enduml