@startuml
'https://plantuml.com/sequence-diagram
title WP3A-15 (Microservices): As a Physician, I want to view the appointment records of a patient

autonumber
autoactivate on

actor "Physician" as Physician
participant "AppointmentRecordController (Appointment Records Service)" as Controller
participant "JWTValidator" as JWT
participant "AppointmentRecordService" as RecordService
participant "AppointmentRecordRepository" as RecordRepo
database "Appointment Records DB" as RecordDB
participant "AppointmentClient (Appointments Service)" as AppointmentClient
participant "AppointmentController (Appointments Service)" as AppointmentController
participant "AppointmentService" as AppointmentService
participant "AppointmentRepository" as AppointmentRepo
database "Appointments DB" as AppointmentDB
participant "AppointmentRecordViewMapper" as ViewMapper

Physician -> Controller : GET /patients/{patientNumber}/records\nAuthorization: Bearer <JWT>
activate Controller

Controller -> JWT : validateToken(JWT)
activate JWT
JWT --> Controller : 200 OK (role=PHYSICIAN, physicianId)
deactivate JWT

Controller -> RecordService : getAppointmentRecordsByPatient(patientNumber, physicianId)
activate RecordService

RecordService -> AppointmentClient : GET /appointments/verify-access?physicianId={physicianId}&patientNumber={patientNumber}
activate AppointmentClient

AppointmentClient -> AppointmentController : GET /appointments/verify-access?physicianId={physicianId}&patientNumber={patientNumber}
activate AppointmentController
AppointmentController -> AppointmentService : verifyPhysicianAccess(physicianId, patientNumber)
activate AppointmentService
AppointmentService -> AppointmentRepo : findByPhysicianIdAndPatientNumber(physicianId, patientNumber)
activate AppointmentRepo
AppointmentRepo -> AppointmentDB : SELECT * FROM appointments WHERE physician_id = ? AND patient_number = ?
AppointmentDB --> AppointmentRepo : Optional<Appointment>
deactivate AppointmentRepo
AppointmentRepo --> AppointmentService : Optional<Appointment>
AppointmentService --> AppointmentController : accessGranted / denied
deactivate AppointmentService
AppointmentController --> AppointmentClient : 200 OK (accessGranted=true)
deactivate AppointmentController
AppointmentClient --> RecordService : accessGranted=true
deactivate AppointmentClient

RecordService -> RecordRepo : findByPatientNumber(patientNumber)
activate RecordRepo
RecordRepo -> RecordDB : SELECT * FROM appointment_records WHERE patient_number = ?
RecordDB --> RecordRepo : List<AppointmentRecord>
deactivate RecordRepo
RecordRepo --> RecordService : List<AppointmentRecord>

RecordService -> ViewMapper : toDTOList(List<AppointmentRecord>)
activate ViewMapper
ViewMapper --> RecordService : List<AppointmentRecordViewDTO>
deactivate ViewMapper

RecordService --> Controller : List<AppointmentRecordViewDTO>
deactivate RecordService

Controller --> Physician : HTTP 200 OK\nBody: List<AppointmentRecordViewDTO>
deactivate Controller

@enduml